<!DOCTYPE html>
<html>
  <head>
    <title>Jupyter Notebook is Starting</title>
    <link rel="shortcut icon" href="/favicon.png"/>
    <meta charset="UTF-8">

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@200;400;600&display=swap');

      body {
        font-family: Poppins, sans-serif;
        background: rgb(43, 43, 43);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      body, html {
        width: 100%;
        height: 100%;
      }

      .pending {
        color: #666;
      }

      .states {
        color: #62B4FF;
      }

      .img-container {
        display: flex;
        justify-content: center;
        height: 50px;
      }

      main {
        position: relative;
        display: flex;
        justify-content: center;
      }

      .content {
        transition: opacity 200ms ease-out 200ms;
        opacity: 1;
      }

      .error-container {
        position: absolute;
        top: 0;
        color: #c64d4d;
        padding: 13px 20px;
        background-color: #e1d0d0;
        border-radius: 6px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease-out 400ms;
      }

      main.error .content {
        opacity: 0;
        pointer-events: none;
      }

      main.error .error-container {
        opacity: 1;
        pointer-events: initial;
      }

      p {
        transition: color 200ms linear;
      }
    </style>
  </head>
  <body>
    <div>
      <div class="img-container">
        <svg viewBox="0 0 443 98" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M45.12 0H27.12V68.64C27.12 76.8 26.52 79.2 22.56 79.2C18.6 79.2 18 76.8 18 68.64V62.64H0V69.84C0 89.16 8.04 97.2 22.56 97.2C37.08 97.2 45.12 89.16 45.12 69.84V0Z" fill="#62B4FF"/>
          <path d="M93.8981 84.48V41.76C93.8981 24.84 87.1781 16.8 71.4581 16.8C55.7381 16.8 48.7781 24.84 48.7781 41.76V44.16H66.7781V41.76C66.7781 36 67.9781 33.6 71.4581 33.6C74.6981 33.6 75.8981 34.8 75.8981 39.24C75.7781 51.96 47.5781 49.32 47.5781 76.92C47.5781 91.08 54.6581 97.2 62.6981 97.2C69.5381 97.2 73.1381 94.08 75.8981 87.24C75.8981 89.4 76.4981 94.2 79.4981 96H95.0981C93.8981 92.16 93.8981 89.52 93.8981 84.48ZM75.8981 77.4C74.6981 78.84 73.0181 80.4 70.6181 80.4C67.6181 80.4 65.5781 78.36 65.5781 73.68C65.5781 66.36 72.1781 63.96 75.8981 58.56V77.4Z" fill="#62B4FF"/>
          <path d="M154.86 16.8C147.78 16.8 142.5 22.08 140.46 27.36C139.02 20.28 135.78 16.8 128.94 16.8C121.62 16.8 117.42 22.44 115.5 26.76V18H97.5V96H115.5V40.56C115.5 34.8 117.06 33.6 119.46 33.6C121.86 33.6 123.42 34.8 123.42 40.56V96H141.42V41.76V40.56C141.42 34.8 142.98 33.6 145.38 33.6C147.78 33.6 149.34 34.8 149.34 40.56V96H167.34V41.76C167.34 24.84 165.3 16.8 154.86 16.8Z" fill="#62B4FF"/>
          <path d="M199.808 50.52C190.448 43.68 187.688 42.24 187.688 38.16C187.688 36 188.648 33.6 191.408 33.6C194.167 33.6 195.607 36 195.607 42.96H213.607C213.607 26.04 206.527 16.8 191.408 16.8C176.288 16.8 169.688 26.04 169.688 38.16C169.688 50.88 177.247 55.8 184.688 60.96C195.607 68.52 196.808 71.04 196.808 74.64C196.808 78 196.088 80.4 192.728 80.4C189.368 80.4 187.688 78 187.688 68.64H169.688C169.688 90.36 177.008 97.2 192.728 97.2C208.448 97.2 214.808 87.96 214.808 74.64C214.808 62.52 208.928 57.24 199.808 50.52Z" fill="#62B4FF"/>
          <path d="M217.266 69.84C217.266 89.16 225.306 97.2 239.826 97.2C254.346 97.2 262.386 89.16 262.386 69.84V44.16C262.386 24.84 254.346 16.8 239.826 16.8C225.306 16.8 217.266 24.84 217.266 44.16V69.84ZM235.266 69.84V44.16C235.266 36 235.866 33.6 239.826 33.6C243.666 33.6 244.386 36 244.386 44.16V69.84C244.386 78 243.786 80.4 239.826 80.4C235.866 80.4 235.266 78 235.266 69.84Z" fill="#62B4FF"/>
          <path d="M291.964 48.6H309.964V44.16C309.964 24.84 301.924 16.8 287.404 16.8C272.884 16.8 264.844 24.84 264.844 44.16V69.84C264.844 89.16 272.884 97.2 287.404 97.2C301.924 97.2 309.964 89.16 309.964 69.84V65.4H291.964V69.84C291.964 78 291.364 80.4 287.404 80.4C283.444 80.4 282.844 78 282.844 69.84V44.16C282.844 36 283.444 33.6 287.404 33.6C291.244 33.6 291.964 36 291.964 44.16V48.6Z" fill="#62B4FF"/>
          <path d="M312.422 0V96H330.422V0H312.422Z" fill="#62B4FF"/>
          <path d="M442 34.8V18H422.8C429.16 16.44 431.2 8.16 431.2 0H413.2C413.32 7.44 411.88 15.96 404.8 18V34.8H412V69.84C412 89.16 415.24 96 432.16 96H442V79.2H436.96C432.4 79.2 430 78 430 69.84V34.8H442Z" fill="#62B4FF"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M341.46 18H360.06L348.18 57L360.06 96H341.46L330.3 57L341.46 18ZM398.9 18H398.3H380.3H362.3V36H385.783L389.438 48H362.3V66H389.438L385.783 78H362.3V96H380.3H398.3H398.9L410.06 57L398.9 18Z" fill="#F5F4F4"/>
        </svg>
      </div>
      <main>
        <div class="content">
          <p>Starting notebook. You will be redirected in a moment.</p>
          <p class="states">
            <span id="loading" class="pending">Loading</span> •
            <span id="starting" class="pending">Starting</span> •
            <span id="ready" class="pending">Ready</span>
          </p>
        </div>
        <p class="error-container"></p>
      </main>
    </div>
    <script>
      // ---- CUSTOMIZE SPAWN / REDIRECT LOGIC BELOW ----˅˅˅

      const SPAWN_TOKEN = '[SPAWN TOKEN HERE]'
      const SPAWN_ENV = {
        JAMSOCKET_JUPYTER_TOKEN: '[SET JUPYTER PASSWORD HERE]'
      }
      spawn(SPAWN_TOKEN, SPAWN_ENV).then(url => {
        document.location = `${url}?token=${encodeURIComponent(SPAWN_ENV.JAMSOCKET_JUPYTER_TOKEN)}`
      }).catch(err => {
        const errMessageElem = document.querySelector('.error-container')
        errMessageElem.innerText = err.message
        const mainElem = document.querySelector('main')
        mainElem.classList.add('error')
      })

      // ---- CUSTOMIZE SPAWN / REDIRECT LOGIC ABOVE ----^^^

      function spawn(spawnToken, spawnEnv) {
        if (spawnEnv) validateEnv(spawnEnv)
        return new Promise((resolve, reject) => {
          const API_BASE = 'https://new.jamsocket.dev'
          const spawnEndpoint = `${API_BASE}/api/token/${spawnToken}/spawn`

          // append #nocache to the URL to force a flush of localStorage up front
          if (document.location.hash === '#nocache') {
            document.location.hash = ''
            console.log('URL includes #nocache. Removing localStorage for spawnToken:', spawnToken)
            localStorage.removeItem(spawnToken)
          }

          let spawnState
          readSpawnState().then(state => {
            if (state) return state
            const body = spawnEnv ? { env: spawnEnv } : {}
            const startTime = Date.now()
            return fetch(spawnEndpoint, {
              method: 'POST',
              headers: new Headers({ 'Content-Type': 'application/json' }),
              mode: 'cors',
              body: JSON.stringify(body)
            }).then(res => res.json())
              .then(res => {
                if (res.error) {
                  const { code, id, message, status } = res.error
                  throw new Error(`${status} ${code}: ${message} (${id})`)
                }
                // Successful spawn response looks like this:
                // {
                //   "url": "https://[NAME].jamsocket.run",
                //   "name": "[NAME]",
                //   "ready_url": "https://new.jamsocket.dev/ready/[NAME]/",
                //   "status_url": "https://new.jamsocket.dev/api/backend/[NAME]/status"
                // }
                console.log('spawning backend', res)
                return {
                  time: startTime,
                  spawnToken: spawnToken,
                  spawnEnv: spawnEnv,
                  spawnResponse: res,
                  receivedEvents: [],
                  isReady: false,
                  isFailed: false
                }
              })
          }).then(state => {
            spawnState = state
            saveSpawnState(spawnState)

            for (const event of spawnState.receivedEvents) {
              if (event.status === 'Ready') {
                onReady(spawnState)
                return
              }
              updateEventUI(event)
            }

            const eventSource = new EventSource(`${spawnState.spawnResponse.status_url}/stream`)
            eventSource.onmessage = (event) => {
              // events data look like: {"state": "Loading","time": "2022-03-01T18:11:17.689823Z"}
              // possible event states:
              // Loading, ErrorLoading, Starting, ErrorStarting, Ready, TimedOutBeforeReady, Failed, Exited, Swept
              const eventData = JSON.parse(event.data)
              addEventToSpawnState(spawnState, eventData)
              updateEventUI(eventData)
              if (eventData.state === 'Ready') {
                onReady(spawnState)
              } else if (['ErrorLoading', 'ErrorStarting', 'TimedOutBeforeReady', 'Failed'].includes(eventData.state)) {
                spawnState.isFailed = true
                spawnState.isReady = false
                saveSpawnState(spawnState)
                reject(new Error(`Error spawning backend. Received backend status: ${eventData.state}`))
              }
            }
          }).catch((err) => {
            if (spawnState) {
              spawnState.isFailed = true
              spawnState.isReady = false
              saveSpawnState(spawnState)
            }
            reject(err)
          })

          function onReady(state) {
            state.isReady = true
            saveSpawnState(state)
            resolve(state.spawnResponse.url)
          }

          function updateEventUI(event) {
            const elem = document.getElementById(event.state.toLowerCase())
            if (!elem) {
              console.warn(`Received event with no corresponding UI element: ${event}`)
              return
            }
            elem.classList.remove('pending')
          }

          function saveSpawnState(spawnState) {
            localStorage.setItem(spawnToken, JSON.stringify(spawnState))
          }

          // reads previous spawn state from localStorage and uses it if the spawned instance
          // is still active. If no previous state exists, the previous spawn failed, or the
          // spawned instance is no longer running, this function returns a Promise that
          // resolves to null
          function readSpawnState() {
            const storedState = localStorage.getItem(spawnToken)
            if (!storedState) return Promise.resolve(null)
            let state
            try {
              state = JSON.parse(storedState)
              console.log('found state in localStorage:', state)
              // if the saved state is for a failed spawn, remove the state from localStorage now
              if (state.isFailed) {
                console.log('previous spawned session failed, ignoring saved state')
                localStorage.removeItem(spawnToken)
                return Promise.resolve(null)
              }
            } catch (error) {
              console.warn(error)
              console.warn(`Error parsing localStorage for spawnToken ${spawnToken}: ${storedState}`)
              localStorage.removeItem(spawnToken)
              return Promise.resolve(null)
            }
            return fetch(state.spawnResponse.status_url, { mode: 'cors' })
              .then(res => res.json())
              .then(res => {
                if (!res || ['ErrorLoading', 'ErrorStarting', 'TimedOutBeforeReady', 'Failed', 'Exited', 'Swept'].includes(res.state)) {
                  console.log(`previous spawned session no longer exists: ${res}`)
                  localStorage.removeItem(spawnToken)
                  return null
                }
                return state
              })
              .catch((error) => {
                console.warn(`error fetching status: ${error}`)
                console.log('clearing localStorage and ignoring previous state')
                localStorage.removeItem(spawnToken)
                return null
              })
          }

          function addEventToSpawnState(state, event) {
            for (const evt of state.receivedEvents) {
              if (evt.state === event.state && evt.time === event.time) return
            }
            state.receivedEvents.push(event)
            saveSpawnState(state)
          }
        })

        function validateEnv(spawnEnv) {
            for (const key of Object.keys(spawnEnv)) {
              if (!key.startsWith('JAMSOCKET_')) {
                throw new Error(`spawn env variables must be prefixed with "JAMSOCKET_". Found invalid key: ${key}`)
              }
            }
          }
      }
    </script>
  </body>
</html>
